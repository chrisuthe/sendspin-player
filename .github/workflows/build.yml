# Sendspin-Player CI/CD Pipeline
name: Build

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build (${{ matrix.rid }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [linux-x64, linux-arm64]

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test
        run: dotnet test --configuration Release --no-build --verbosity normal
        continue-on-error: true  # Tests may not exist yet

      - name: Publish
        run: |
          dotnet publish src/Sendspin.Player/Sendspin.Player.csproj \
            --configuration Release \
            --runtime ${{ matrix.rid }} \
            --self-contained \
            --output ./publish/${{ matrix.rid }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sendspin-player-${{ matrix.rid }}
          path: ./publish/${{ matrix.rid }}
          retention-days: 14

  # Only build AppImage on linux-x64 for now
  package-appimage:
    name: Package AppImage
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: sendspin-player-linux-x64
          path: ./publish/linux-x64

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage
        run: |
          mkdir -p AppDir/usr/bin
          cp -r ./publish/linux-x64/* AppDir/usr/bin/
          chmod +x AppDir/usr/bin/Sendspin.Player

          # AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE=$(dirname "$(readlink -f "$0")")
          exec "$HERE/usr/bin/Sendspin.Player" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Desktop file
          cat > AppDir/sendspin.desktop << 'EOF'
          [Desktop Entry]
          Name=Sendspin
          Exec=Sendspin.Player
          Icon=sendspin
          Type=Application
          Categories=Audio;
          EOF

          # Placeholder icon (1x1 transparent PNG)
          echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==' | base64 -d > AppDir/sendspin.png

          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir Sendspin-Player-x86_64.AppImage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: sendspin-player-appimage
          path: Sendspin-Player-x86_64.AppImage
          retention-days: 30

  # Build Flatpak package
  package-flatpak:
    name: Package Flatpak
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: sendspin-player-linux-x64
          path: ./publish/linux-x64

      - name: Install Flatpak tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Create Flatpak
        run: |
          # Create manifest
          cat > io.sendspin.client.yml << 'EOF'
          app-id: io.sendspin.client
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: Sendspin.Player
          finish-args:
            - --share=ipc
            - --socket=x11
            - --socket=wayland
            - --socket=fallback-x11
            - --socket=pulseaudio
            - --share=network
            - --device=dri
            - --talk-name=org.freedesktop.Notifications
          modules:
            - name: sendspin
              buildsystem: simple
              build-commands:
                - mkdir -p /app/bin
                - cp -r app-files/* /app/bin/
                - chmod +x /app/bin/Sendspin.Player
                - mkdir -p /app/share/applications
                - |
                  cat > /app/share/applications/io.sendspin.client.desktop << 'DESKTOP'
                  [Desktop Entry]
                  Name=Sendspin
                  Exec=Sendspin.Player
                  Icon=io.sendspin.client
                  Type=Application
                  Categories=Audio;
                  DESKTOP
              sources:
                - type: dir
                  path: publish/linux-x64
                  dest: app-files
          EOF

          # Build Flatpak
          flatpak-builder --user --force-clean --repo=repo build-dir io.sendspin.client.yml

          # Create bundle
          flatpak build-bundle repo Sendspin-Player.flatpak io.sendspin.client

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: sendspin-player-flatpak
          path: Sendspin-Player.flatpak
          retention-days: 30
