# =============================================================================
# Sendspin Linux Client - Flatpak Manifest
# =============================================================================
# Build on Linux (Fedora):
#   cd packaging/flatpak
#   flatpak-builder --user --force-clean --repo=repo build-dir io.sendspin.client.yml
#   flatpak build-bundle repo sendspin.flatpak io.sendspin.client
#
# Install:
#   flatpak install --user sendspin.flatpak
#
# Run:
#   flatpak run io.sendspin.client
# =============================================================================

app-id: io.sendspin.client
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk

command: Sendspin.Player

# Sandbox permissions
finish-args:
  # Display access - X11/XWayland required (Avalonia uses XWayland on Wayland desktops)
  - --share=ipc
  - --socket=x11

  # Audio access (PipeWire/PulseAudio)
  - --socket=pulseaudio

  # Network access (for mDNS discovery and streaming)
  - --share=network

  # GPU acceleration for Avalonia
  - --device=dri

  # System notifications via D-Bus
  - --talk-name=org.freedesktop.Notifications

  # Discord Rich Presence (optional)
  - --filesystem=xdg-run/discord-ipc-0:ro

  # Portal access for native dialogs
  - --talk-name=org.freedesktop.portal.*

modules:
  - name: sendspin
    buildsystem: simple
    build-commands:
      # Create app directories
      - mkdir -p /app/lib/sendspin
      - mkdir -p /app/bin

      # Copy all application files
      - cp -r sendspin-app/* /app/lib/sendspin/

      # Make main executable runnable
      - chmod +x /app/lib/sendspin/Sendspin.Player

      # Create wrapper script in bin
      - |
        cat > /app/bin/Sendspin.Player << 'EOF'
        #!/bin/sh
        exec /app/lib/sendspin/Sendspin.Player "$@"
        EOF
      - chmod +x /app/bin/Sendspin.Player

      # Install desktop file
      - install -Dm644 io.sendspin.client.desktop /app/share/applications/io.sendspin.client.desktop

      # Install AppStream metadata
      - install -Dm644 io.sendspin.client.appdata.xml /app/share/metainfo/io.sendspin.client.appdata.xml

      # Install icon (placeholder - add real icon later)
      - |
        mkdir -p /app/share/icons/hicolor/256x256/apps
        if [ -f sendspin-256.png ]; then
          install -Dm644 sendspin-256.png /app/share/icons/hicolor/256x256/apps/io.sendspin.client.png
        fi

    sources:
      # Published .NET application (all files)
      - type: dir
        path: sendspin-app
        dest: sendspin-app

      # Desktop file
      - type: file
        path: io.sendspin.client.desktop

      # AppStream metadata
      - type: file
        path: io.sendspin.client.appdata.xml

      # Application icon
      - type: file
        path: sendspin-256.png
